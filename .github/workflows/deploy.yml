name: Simple SSH Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH Deploy to EC2
        run: |
          # Write SSH key
          echo "${{ secrets.TALHA_KEY }}" > ~/ssh_key
          chmod 600 ~/ssh_key

          # Connect and run remote commands
          ssh -i ~/ssh_key -o StrictHostKeyChecking=no ubuntu@3.27.171.210 "
            # Navigate to project
            cd ~/CICD/http &&

            # Force sync with latest GitHub repo
            git fetch origin &&
            git reset --hard origin/main &&

            # Install dependencies and build
            npm install &&
            npm run build &&

            # Restart or start server using PM2
            pm2 restart http-server || pm2 start dist/index.js --name http-server
          "
